# ESP8266 Driver Integration Guide

This guide explains how to integrate the ESP8266 driver into any STM32 project.

## üìÅ Files to Copy

Copy these files to your STM32 project:

```
Core/
‚îú‚îÄ‚îÄ Inc/
‚îÇ   ‚îî‚îÄ‚îÄ esp8266.h          # Driver header file
‚îî‚îÄ‚îÄ Src/
    ‚îî‚îÄ‚îÄ esp8266.c          # Driver implementation
```

## üîß Basic Integration

### 1. Include the Header
In your `main.c`:
```c
#include "esp8266.h"
```

### 2. Add Configuration Defines
Add these defines to your `main.c` (adjust values as needed):
```c
/* WiFi Configuration */
#define WIFI_SSID                   "Your_WiFi_Network"
#define WIFI_PASSWORD               "Your_WiFi_Password"

/* MQTT Configuration */
#define MQTT_BROKER_IP              "192.168.1.100"
#define MQTT_BROKER_PORT            1883
#define MQTT_CLIENT_ID              "STM32_Device_001"
#define MQTT_TOPIC_CONTROL          "device/control"
#define MQTT_TOPIC_STATUS           "device/status"
```

### 3. Initialize the Driver
In your `main()` function:
```c
// Initialize ESP8266 with your UART (e.g., UART2)
if (ESP8266_Init(&huart2) == ESP8266_OK) {
    // Connect to WiFi
    if (ESP8266_ConnectWiFi(WIFI_SSID, WIFI_PASSWORD) == ESP8266_OK) {
        // Connect to MQTT broker
        if (ESP8266_ConnectMQTT(MQTT_BROKER_IP, MQTT_BROKER_PORT, MQTT_CLIENT_ID) == ESP8266_OK) {
            // Subscribe to control topic
            ESP8266_SubscribeMQTT(MQTT_TOPIC_CONTROL);
            
            // Publish initial status
            ESP8266_PublishMQTT(MQTT_TOPIC_STATUS, "Device Connected");
        }
    }
}
```

### 4. Add Main Loop Processing
In your main loop:
```c
while (1) {
    // Process ESP8266 DMA data
    ESP8266_ProcessDMAData();
    
    // Your other application code here
    
    // Small delay to prevent excessive CPU usage
    HAL_Delay(10);
}
```

### 5. Implement MQTT Message Callback
Add this function to your `main.c`:
```c
void ESP8266_OnMQTTMessageReceived(const char* topic, const char* message) {
    // Handle incoming MQTT messages
    if (strcmp(topic, MQTT_TOPIC_CONTROL) == 0) {
        // Handle control commands
        if (strcmp(message, "ON") == 0) {
            // Turn something on
        } else if (strcmp(message, "OFF") == 0) {
            // Turn something off
        }
    }
}
```

## üîß UART Configuration

The driver supports any UART peripheral. Configure your UART in STM32CubeMX:

### Required Settings
- **Baud Rate**: 115200
- **Data Bits**: 8
- **Stop Bits**: 1
- **Parity**: None
- **Flow Control**: None

### DMA Configuration
Enable DMA for both TX and RX:
- **RX DMA**: Circular mode
- **TX DMA**: Normal mode
- **Priority**: Medium or High

### Example UART Initialization
```c
// This is typically generated by STM32CubeMX
huart2.Instance = USART2;
huart2.Init.BaudRate = 115200;
huart2.Init.WordLength = UART_WORDLENGTH_8B;
huart2.Init.StopBits = UART_STOPBITS_1;
huart2.Init.Parity = UART_PARITY_NONE;
huart2.Init.Mode = UART_MODE_TX_RX;
huart2.Init.HwFlowCtl = UART_HWCONTROL_NONE;
huart2.Init.OverSampling = UART_OVERSAMPLING_16;
```

## üì° API Reference

### Core Functions

#### `ESP8266_Init(UART_HandleTypeDef* huart)`
Initialize ESP8266 module with specified UART.
- **Parameters**: UART handle pointer
- **Returns**: ESP8266_OK on success, ESP8266_ERROR on failure

#### `ESP8266_ConnectWiFi(ssid, password)`
Connect to WiFi network.
- **Parameters**: Network name and password
- **Returns**: ESP8266_OK on success

#### `ESP8266_ConnectMQTT(ip, port, client_id)`
Connect to MQTT broker.
- **Parameters**: Broker IP, port, and client ID
- **Returns**: ESP8266_OK on success

#### `ESP8266_SubscribeMQTT(topic)`
Subscribe to MQTT topic.
- **Parameters**: Topic string
- **Returns**: ESP8266_OK on success

#### `ESP8266_PublishMQTT(topic, message)`
Publish message to MQTT topic.
- **Parameters**: Topic and message strings
- **Returns**: ESP8266_OK on success

#### `ESP8266_ProcessDMAData()`
Process incoming DMA data. Call regularly in main loop.

### Callback Functions

#### `ESP8266_OnMQTTMessageReceived(topic, message)`
Called when MQTT message is received. Implement this function in your application.

## üèóÔ∏è Advanced Usage

### Custom AT Commands
You can send custom AT commands using:
```c
ESP8266_SendCommand("AT+COMMAND\r\n", "OK", 1000);
```

### Error Handling
All functions return `ESP8266_Status_t`:
- `ESP8266_OK`: Success
- `ESP8266_ERROR`: General error
- `ESP8266_TIMEOUT`: Command timeout

### Buffer Management
- Internal buffer size: 512 bytes
- DMA buffer size: 256 bytes
- Adjust these in `esp8266.h` if needed

## üîç Troubleshooting

### Common Issues

1. **Initialization fails**: Check UART connections and power supply
2. **WiFi connection fails**: Verify SSID/password and signal strength
3. **MQTT connection fails**: Check broker IP and port
4. **No MQTT messages**: Ensure `ESP8266_ProcessDMAData()` is called regularly

### Debug Tips

1. **Check DMA buffer**: Set breakpoint in `ESP8266_ProcessDMAData()`
2. **Monitor AT responses**: Use debugger to examine `esp8266_buffer`
3. **Test manually**: Send AT commands directly to ESP8266

## üìã Project Examples

### Simple LED Control
```c
void ESP8266_OnMQTTMessageReceived(const char* topic, const char* message) {
    if (strcmp(topic, "led/control") == 0) {
        if (strcmp(message, "ON") == 0) {
            HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_SET);
        } else if (strcmp(message, "OFF") == 0) {
            HAL_GPIO_WritePin(LED_GPIO_Port, LED_Pin, GPIO_PIN_RESET);
        }
    }
}
```

### Sensor Data Publishing
```c
void PublishSensorData() {
    char sensor_data[50];
    float temperature = ReadTemperature();
    
    snprintf(sensor_data, sizeof(sensor_data), "%.2f", temperature);
    ESP8266_PublishMQTT("sensor/temperature", sensor_data);
}
```

### Multiple Topic Handling
```c
void ESP8266_OnMQTTMessageReceived(const char* topic, const char* message) {
    if (strcmp(topic, "device/led") == 0) {
        // Handle LED control
    } else if (strcmp(topic, "device/motor") == 0) {
        // Handle motor control
    } else if (strcmp(topic, "device/config") == 0) {
        // Handle configuration
    }
}
```

## üîó Dependencies

- STM32 HAL Library
- Standard C library (string.h, stdio.h, stdbool.h)
- ESP8266 module with AT firmware v2.0+

## üìÑ License

This driver is provided under the MIT License. See the main project LICENSE file for details.
